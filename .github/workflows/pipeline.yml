name: CI Protectora API

# Esto define cuándo se ejecuta: al hacer push o pull request a la rama main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # GitHub nos presta una máquina Linux virtual

    steps:
    # 1. Bajamos el código a la máquina virtual
    - name: Checkout del código
      uses: actions/checkout@v3

    # 2. Instalamos Python 3.10 en esa máquina
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # 3. Instalamos las librerías que definimos en requirements.txt
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Aseguramos que se instalan herramientas de test si no estaban en el txt
        pip install httpx pytest ruff 

    # 4. Revisamos que el código esté limpio (Linter)
    - name: Analisis estático (Ruff)
      run: |
        ruff check .

    # 5. Ejecutamos los tests unitarios (Lógica pura: PetService)
    - name: Tests Unitarios
      run: |
        python -m pytest tests/test_unit.py

    # 6. IMPORTANTE: Arrancamos tu API en segundo plano
    # El '&' al final es vital para que no bloquee el terminal y pase al siguiente paso
    - name: Tests End-to-End
      run: |
        python -m pytest tests/test_e2e.py
        
    # 7. Ejecutamos los tests End-to-End contra la API ya encendida
    - name: Tests End-to-End
      run: |
        pytest tests/test_e2e.py